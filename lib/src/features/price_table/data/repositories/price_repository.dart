// lib/src/features/price_table/data/repositories/price_repository.dart
import 'package:dio/dio.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:genotek_test_app/src/core/network/dio_client.dart';
import 'package:genotek_test_app/src/features/price_table/domain/models/price_item.dart';

final priceRepositoryProvider =
    AsyncNotifierProvider<PriceRepository, Map<String, List<PriceItem>>>(() {
  return PriceRepository(dio: DioClient.instance);
});

class PriceRepository extends AsyncNotifier<Map<String, List<PriceItem>>> {
  final Dio dio;

  PriceRepository({required this.dio});

  Future<Map<String, List<PriceItem>>> fetchPrices() async {
    const maxRetries = 3;
    const retryDelay = Duration(seconds: 2);

    for (var attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        final response = await dio.get('https://back.genotek.ru/api/price/');
        final Map<String, dynamic> data = response.data;

        final Map<String, List<PriceItem>> tables = {
          'genealogy': [],
          'genetics': [],
          'premium': [],
          'diagnostics': [],
        };

        // Process diagnostic data differently
        if (data.containsKey('diagnostic')) {
          final diagnosticData = data['diagnostic'] as Map<String, dynamic>;
          tables['diagnostics'] = diagnosticData.entries.map((entry) {
            final itemData = entry.value as Map<String, dynamic>;
            return PriceItem.fromJson({
              'id': entry.key,
              'name': itemData['name'] as String? ?? 'Unknown',
              'category': 'Diagnostics',
              'discountState': itemData['discountState'] == true,
              'discountStateEu': itemData['discountStateEu'] == true,
              'discountStateUsd': itemData['discountStateUsd'] == true,
              'discountStatePen': itemData['discountStatePen'] == true,
              'price': itemData['price']?.toDouble(),
              'priceEu': itemData['priceEu']?.toDouble(),
              'priceUsd': itemData['priceUsd']?.toDouble(),
              'pricePen': itemData['pricePen']?.toDouble(),
              'priceCl': itemData['priceCl']?.toDouble(),
              'priceAed': itemData['priceAed']?.toDouble(),
              'priceAll': itemData['priceAll']?.toDouble(),
              'priceAmd': itemData['priceAmd']?.toDouble(),
              'priceAoa': itemData['priceAoa']?.toDouble(),
              'priceAud': itemData['priceAud']?.toDouble(),
              'priceBam': itemData['priceBam']?.toDouble(),
              'priceBdt': itemData['priceBdt']?.toDouble(),
              'priceCzk': itemData['priceCzk']?.toDouble(),
              'priceDkk': itemData['priceDkk']?.toDouble(),
              'priceDzd': itemData['priceDzd']?.toDouble(),
              'priceEgp': itemData['priceEgp']?.toDouble(),
              'priceEtb': itemData['priceEtb']?.toDouble(),
              'priceGel': itemData['priceGel']?.toDouble(),
              'priceHkd': itemData['priceHkd']?.toDouble(),
              'priceHuf': itemData['priceHuf']?.toDouble(),
              'priceInr': itemData['priceInr']?.toDouble(),
              'priceKes': itemData['priceKes']?.toDouble(),
              'priceKgs': itemData['priceKgs']?.toDouble(),
              'priceKzt': itemData['priceKzt']?.toDouble(),
              'priceMad': itemData['priceMad']?.toDouble(),
              'priceMdl': itemData['priceMdl']?.toDouble(),
              'priceMxn': itemData['priceMxn']?.toDouble(),
              'priceMyr': itemData['priceMyr']?.toDouble(),
              'priceNgn': itemData['priceNgn']?.toDouble(),
              'priceNpr': itemData['priceNpr']?.toDouble(),
              'priceNzd': itemData['priceNzd']?.toDouble(),
              'pricePhp': itemData['pricePhp']?.toDouble(),
              'pricePkr': itemData['pricePkr']?.toDouble(),
              'pricePln': itemData['pricePln']?.toDouble(),
              'priceQar': itemData['priceQar']?.toDouble(),
              'priceRon': itemData['priceRon']?.toDouble(),
              'priceRsd': itemData['priceRsd']?.toDouble(),
              'priceSar': itemData['priceSar']?.toDouble(),
              'priceSek': itemData['priceSek']?.toDouble(),
              'priceSgd': itemData['priceSgd']?.toDouble(),
              'priceThb': itemData['priceThb']?.toDouble(),
              'priceTjs': itemData['priceTjs']?.toDouble(),
              'priceZar': itemData['priceZar']?.toDouble(),
              'priceUyu': itemData['priceUyu']?.toDouble(),
              'priceChf': itemData['priceChf']?.toDouble(),
              'priceNok': itemData['priceNok']?.toDouble(),
              'priceGbp': itemData['priceGbp']?.toDouble(),
              'startPriceEu': itemData['startPriceEu']?.toDouble(),
              'discountPriceEu': itemData['discountPriceEu']?.toDouble(),
              'startPriceUsd': itemData['startPriceUsd']?.toDouble(),
              'discountPriceUsd': itemData['discountPriceUsd']?.toDouble(),
              'startPricePen': itemData['startPricePen']?.toDouble(),
              'discountPricePen': itemData['discountPricePen']?.toDouble(),
              'startPriceCl': itemData['startPriceCl']?.toDouble(),
              'discountPriceCl': itemData['discountPriceCl']?.toDouble(),
              'discountStateCl': itemData['discountStateCl'] == true,
              'startPriceAed': itemData['startPriceAed']?.toDouble(),
              'discountPriceAed': itemData['discountPriceAed']?.toDouble(),
              'discountStateAed': itemData['discountStateAed'] == true,
              'startPriceAll': itemData['startPriceAll']?.toDouble(),
              'discountPriceAll': itemData['discountPriceAll']?.toDouble(),
              'discountStateAll': itemData['discountStateAll'] == true,
              'startPriceAmd': itemData['startPriceAmd']?.toDouble(),
              'discountPriceAmd': itemData['discountPriceAmd']?.toDouble(),
              'discountStateAmd': itemData['discountStateAmd'] == true,
              'startPriceAoa': itemData['startPriceAoa']?.toDouble(),
              'discountPriceAoa': itemData['discountPriceAoa']?.toDouble(),
              'discountStateAoa': itemData['discountStateAoa'] == true,
              'startPriceAud': itemData['startPriceAud']?.toDouble(),
              'discountPriceAud': itemData['discountPriceAud']?.toDouble(),
              'discountStateAud': itemData['discountStateAud'] == true,
              'startPriceBam': itemData['startPriceBam']?.toDouble(),
              'discountPriceBam': itemData['discountPriceBam']?.toDouble(),
              'discountStateBam': itemData['discountStateBam'] == true,
              'startPriceBdt': itemData['startPriceBdt']?.toDouble(),
              'discountPriceBdt': itemData['discountPriceBdt']?.toDouble(),
              'discountStateBdt': itemData['discountStateBdt'] == true,
              'startPriceCzk': itemData['startPriceCzk']?.toDouble(),
              'discountPriceCzk': itemData['discountPriceCzk']?.toDouble(),
              'discountStateCzk': itemData['discountStateCzk'] == true,
              'startPriceDkk': itemData['startPriceDkk']?.toDouble(),
              'discountPriceDkk': itemData['discountPriceDkk']?.toDouble(),
              'discountStateDkk': itemData['discountStateDkk'] == true,
              'startPriceDzd': itemData['startPriceDzd']?.toDouble(),
              'discountPriceDzd': itemData['discountPriceDzd']?.toDouble(),
              'discountStateDzd': itemData['discountStateDzd'] == true,
              'startPriceEgp': itemData['startPriceEgp']?.toDouble(),
              'discountPriceEgp': itemData['discountPriceEgp']?.toDouble(),
              'discountStateEgp': itemData['discountStateEgp'] == true,
              'startPriceEtb': itemData['startPriceEtb']?.toDouble(),
              'discountPriceEtb': itemData['discountPriceEtb']?.toDouble(),
              'discountStateEtb': itemData['discountStateEtb'] == true,
              'startPriceGel': itemData['startPriceGel']?.toDouble(),
              'discountPriceGel': itemData['discountPriceGel']?.toDouble(),
              'discountStateGel': itemData['discountStateGel'] == true,
              'startPriceHkd': itemData['startPriceHkd']?.toDouble(),
              'discountPriceHkd': itemData['discountPriceHkd']?.toDouble(),
              'discountStateHkd': itemData['discountStateHkd'] == true,
              'startPriceHuf': itemData['startPriceHuf']?.toDouble(),
              'discountPriceHuf': itemData['discountPriceHuf']?.toDouble(),
              'discountStateHuf': itemData['discountStateHuf'] == true,
              'startPriceInr': itemData['startPriceInr']?.toDouble(),
              'discountPriceInr': itemData['discountPriceInr']?.toDouble(),
              'discountStateInr': itemData['discountStateInr'] == true,
              'startPriceKes': itemData['startPriceKes']?.toDouble(),
              'discountPriceKes': itemData['discountPriceKes']?.toDouble(),
              'discountStateKes': itemData['discountStateKes'] == true,
              'startPriceKgs': itemData['startPriceKgs']?.toDouble(),
              'discountPriceKgs': itemData['discountPriceKgs']?.toDouble(),
              'discountStateKgs': itemData['discountStateKgs'] == true,
              'startPriceKzt': itemData['startPriceKzt']?.toDouble(),
              'discountPriceKzt': itemData['discountPriceKzt']?.toDouble(),
              'discountStateKzt': itemData['discountStateKzt'] == true,
              'startPriceMad': itemData['startPriceMad']?.toDouble(),
              'discountPriceMad': itemData['discountPriceMad']?.toDouble(),
              'discountStateMad': itemData['discountStateMad'] == true,
              'startPriceMdl': itemData['startPriceMdl']?.toDouble(),
              'discountPriceMdl': itemData['discountPriceMdl']?.toDouble(),
              'discountStateMdl': itemData['discountStateMdl'] == true,
              'startPriceMxn': itemData['startPriceMxn']?.toDouble(),
              'discountPriceMxn': itemData['discountPriceMxn']?.toDouble(),
              'discountStateMxn': itemData['discountStateMxn'] == true,
              'startPriceMyr': itemData['startPriceMyr']?.toDouble(),
              'discountPriceMyr': itemData['discountPriceMyr']?.toDouble(),
              'discountStateMyr': itemData['discountStateMyr'] == true,
              'startPriceNgn': itemData['startPriceNgn']?.toDouble(),
              'discountPriceNgn': itemData['discountPriceNgn']?.toDouble(),
              'discountStateNgn': itemData['discountStateNgn'] == true,
              'startPriceNpr': itemData['startPriceNpr']?.toDouble(),
              'discountPriceNpr': itemData['discountPriceNpr']?.toDouble(),
              'discountStateNpr': itemData['discountStateNpr'] == true,
              'startPriceNzd': itemData['startPriceNzd']?.toDouble(),
              'discountPriceNzd': itemData['discountPriceNzd']?.toDouble(),
              'discountStateNzd': itemData['discountStateNzd'] == true,
              'startPricePhp': itemData['startPricePhp']?.toDouble(),
              'discountPricePhp': itemData['discountPricePhp']?.toDouble(),
              'discountStatePhp': itemData['discountStatePhp'] == true,
              'startPricePkr': itemData['startPricePkr']?.toDouble(),
              'discountPricePkr': itemData['discountPricePkr']?.toDouble(),
              'discountStatePkr': itemData['discountStatePkr'] == true,
              'startPricePln': itemData['startPricePln']?.toDouble(),
              'discountPricePln': itemData['discountPricePln']?.toDouble(),
              'discountStatePln': itemData['discountStatePln'] == true,
              'startPriceQar': itemData['startPriceQar']?.toDouble(),
              'discountPriceQar': itemData['discountPriceQar']?.toDouble(),
              'discountStateQar': itemData['discountStateQar'] == true,
              'startPriceRon': itemData['startPriceRon']?.toDouble(),
              'discountPriceRon': itemData['discountPriceRon']?.toDouble(),
              'discountStateRon': itemData['discountStateRon'] == true,
              'startPriceRsd': itemData['startPriceRsd']?.toDouble(),
              'discountPriceRsd': itemData['discountPriceRsd']?.toDouble(),
              'discountStateRsd': itemData['discountStateRsd'] == true,
              'startPriceSar': itemData['startPriceSar']?.toDouble(),
              'discountPriceSar': itemData['discountPriceSar']?.toDouble(),
              'discountStateSar': itemData['discountStateSar'] == true,
              'startPriceSek': itemData['startPriceSek']?.toDouble(),
              'discountPriceSek': itemData['discountPriceSek']?.toDouble(),
              'discountStateSek': itemData['discountStateSek'] == true,
              'startPriceSgd': itemData['startPriceSgd']?.toDouble(),
              'discountPriceSgd': itemData['discountPriceSgd']?.toDouble(),
              'discountStateSgd': itemData['discountStateSgd'] == true,
              'startPriceThb': itemData['startPriceThb']?.toDouble(),
              'discountPriceThb': itemData['discountPriceThb']?.toDouble(),
              'discountStateThb': itemData['discountStateThb'] == true,
              'startPriceTjs': itemData['startPriceTjs']?.toDouble(),
              'discountPriceTjs': itemData['discountPriceTjs']?.toDouble(),
              'discountStateTjs': itemData['discountStateTjs'] == true,
              'startPriceZar': itemData['startPriceZar']?.toDouble(),
              'discountPriceZar': itemData['discountPriceZar']?.toDouble(),
              'discountStateZar': itemData['discountStateZar'] == true,
              'startPriceUyu': itemData['startPriceUyu']?.toDouble(),
              'discountPriceUyu': itemData['discountPriceUyu']?.toDouble(),
              'discountStateUyu': itemData['discountStateUyu'] == true,
              'startPriceChf': itemData['startPriceChf']?.toDouble(),
              'discountPriceChf': itemData['discountPriceChf']?.toDouble(),
              'discountStateChf': itemData['discountStateChf'] == true,
              'startPriceNok': itemData['startPriceNok']?.toDouble(),
              'discountPriceNok': itemData['discountPriceNok']?.toDouble(),
              'discountStateNok': itemData['discountStateNok'] == true,
              'startPriceGbp': itemData['startPriceGbp']?.toDouble(),
              'discountPriceGbp': itemData['discountPriceGbp']?.toDouble(),
              'discountStateGbp': itemData['discountStateGbp'] == true,
              'description': itemData['description'] as String?,
              'href': itemData['href'] as String?,
            });
          }).toList();
        }

        // Process genetics data
        if (data.containsKey('genetics')) {
          final geneticsData = data['genetics'] as Map<String, dynamic>;
          tables['genetics'] = geneticsData.entries.map((entry) {
            final itemData = entry.value as Map<String, dynamic>;
            return PriceItem.fromJson({
              'id': entry.key,
              'name': itemData['name'] as String? ?? 'Unknown',
              'category': itemData['category'] as String? ?? 'Genetics',
              'discountState': itemData['discountState'] == true,
              'discountStateEu': itemData['discountStateEu'] == true,
              'discountStateUsd': itemData['discountStateUsd'] == true,
              'discountStatePen': itemData['discountStatePen'] == true,
              'discountPrice': itemData['discountPrice']?.toDouble(),
              'discountSize': itemData['discountSize'] as String?,
              'price': itemData['price']?.toDouble(),
              'startPrice': itemData['startPrice']?.toDouble(),
              'priceEu': itemData['priceEu']?.toDouble(),
              'priceUsd': itemData['priceUsd']?.toDouble(),
              'pricePen': itemData['pricePen']?.toDouble(),
              'priceCl': itemData['priceCl']?.toDouble(),
              'priceAed': itemData['priceAed']?.toDouble(),
              'priceAll': itemData['priceAll']?.toDouble(),
              'priceAmd': itemData['priceAmd']?.toDouble(),
              'priceAoa': itemData['priceAoa']?.toDouble(),
              'priceAud': itemData['priceAud']?.toDouble(),
              'priceBam': itemData['priceBam']?.toDouble(),
              'priceBdt': itemData['priceBdt']?.toDouble(),
              'priceCzk': itemData['priceCzk']?.toDouble(),
              'priceDkk': itemData['priceDkk']?.toDouble(),
              'priceDzd': itemData['priceDzd']?.toDouble(),
              'priceEgp': itemData['priceEgp']?.toDouble(),
              'priceEtb': itemData['priceEtb']?.toDouble(),
              'priceGel': itemData['priceGel']?.toDouble(),
              'priceHkd': itemData['priceHkd']?.toDouble(),
              'priceHuf': itemData['priceHuf']?.toDouble(),
              'priceInr': itemData['priceInr']?.toDouble(),
              'priceKes': itemData['priceKes']?.toDouble(),
              'priceKgs': itemData['priceKgs']?.toDouble(),
              'priceKzt': itemData['priceKzt']?.toDouble(),
              'priceMad': itemData['priceMad']?.toDouble(),
              'priceMdl': itemData['priceMdl']?.toDouble(),
              'priceMxn': itemData['priceMxn']?.toDouble(),
              'priceMyr': itemData['priceMyr']?.toDouble(),
              'priceNgn': itemData['priceNgn']?.toDouble(),
              'priceNpr': itemData['priceNpr']?.toDouble(),
              'priceNzd': itemData['priceNzd']?.toDouble(),
              'pricePhp': itemData['pricePhp']?.toDouble(),
              'pricePkr': itemData['pricePkr']?.toDouble(),
              'pricePln': itemData['pricePln']?.toDouble(),
              'priceQar': itemData['priceQar']?.toDouble(),
              'priceRon': itemData['priceRon']?.toDouble(),
              'priceRsd': itemData['priceRsd']?.toDouble(),
              'priceSar': itemData['priceSar']?.toDouble(),
              'priceSek': itemData['priceSek']?.toDouble(),
              'priceSgd': itemData['priceSgd']?.toDouble(),
              'priceThb': itemData['priceThb']?.toDouble(),
              'priceTjs': itemData['priceTjs']?.toDouble(),
              'priceZar': itemData['priceZar']?.toDouble(),
              'priceUyu': itemData['priceUyu']?.toDouble(),
              'priceChf': itemData['priceChf']?.toDouble(),
              'priceNok': itemData['priceNok']?.toDouble(),
              'priceGbp': itemData['priceGbp']?.toDouble(),
              'description': itemData['description'] as String?,
              'href': itemData['href'] as String?,
              'startPriceCl': itemData['startPriceCl']?.toDouble(),
              'discountPriceCl': itemData['discountPriceCl']?.toDouble(),
              'discountStateCl': itemData['discountStateCl'] == true,
              'startPriceAed': itemData['startPriceAed']?.toDouble(),
              'discountPriceAed': itemData['discountPriceAed']?.toDouble(),
              'discountStateAed': itemData['discountStateAed'] == true,
              'startPriceAll': itemData['startPriceAll']?.toDouble(),
              'discountPriceAll': itemData['discountPriceAll']?.toDouble(),
              'discountStateAll': itemData['discountStateAll'] == true,
              'startPriceAmd': itemData['startPriceAmd']?.toDouble(),
              'discountPriceAmd': itemData['discountPriceAmd']?.toDouble(),
              'discountStateAmd': itemData['discountStateAmd'] == true,
              'startPriceAoa': itemData['startPriceAoa']?.toDouble(),
              'discountPriceAoa': itemData['discountPriceAoa']?.toDouble(),
              'discountStateAoa': itemData['discountStateAoa'] == true,
              'startPriceAud': itemData['startPriceAud']?.toDouble(),
              'discountPriceAud': itemData['discountPriceAud']?.toDouble(),
              'discountStateAud': itemData['discountStateAud'] == true,
              'startPriceBam': itemData['startPriceBam']?.toDouble(),
              'discountPriceBam': itemData['discountPriceBam']?.toDouble(),
              'discountStateBam': itemData['discountStateBam'] == true,
              'startPriceBdt': itemData['startPriceBdt']?.toDouble(),
              'discountPriceBdt': itemData['discountPriceBdt']?.toDouble(),
              'discountStateBdt': itemData['discountStateBdt'] == true,
              'startPriceCzk': itemData['startPriceCzk']?.toDouble(),
              'discountPriceCzk': itemData['discountPriceCzk']?.toDouble(),
              'discountStateCzk': itemData['discountStateCzk'] == true,
              'startPriceDkk': itemData['startPriceDkk']?.toDouble(),
              'discountPriceDkk': itemData['discountPriceDkk']?.toDouble(),
              'discountStateDkk': itemData['discountStateDkk'] == true,
              'startPriceDzd': itemData['startPriceDzd']?.toDouble(),
              'discountPriceDzd': itemData['discountPriceDzd']?.toDouble(),
              'discountStateDzd': itemData['discountStateDzd'] == true,
              'startPriceEgp': itemData['startPriceEgp']?.toDouble(),
              'discountPriceEgp': itemData['discountPriceEgp']?.toDouble(),
              'discountStateEgp': itemData['discountStateEgp'] == true,
              'startPriceEtb': itemData['startPriceEtb']?.toDouble(),
              'discountPriceEtb': itemData['discountPriceEtb']?.toDouble(),
              'discountStateEtb': itemData['discountStateEtb'] == true,
              'startPriceGel': itemData['startPriceGel']?.toDouble(),
              'discountPriceGel': itemData['discountPriceGel']?.toDouble(),
              'discountStateGel': itemData['discountStateGel'] == true,
              'startPriceHkd': itemData['startPriceHkd']?.toDouble(),
              'discountPriceHkd': itemData['discountPriceHkd']?.toDouble(),
              'discountStateHkd': itemData['discountStateHkd'] == true,
              'startPriceHuf': itemData['startPriceHuf']?.toDouble(),
              'discountPriceHuf': itemData['discountPriceHuf']?.toDouble(),
              'discountStateHuf': itemData['discountStateHuf'] == true,
              'startPriceInr': itemData['startPriceInr']?.toDouble(),
              'discountPriceInr': itemData['discountPriceInr']?.toDouble(),
              'discountStateInr': itemData['discountStateInr'] == true,
              'startPriceKes': itemData['startPriceKes']?.toDouble(),
              'discountPriceKes': itemData['discountPriceKes']?.toDouble(),
              'discountStateKes': itemData['discountStateKes'] == true,
              'startPriceKgs': itemData['startPriceKgs']?.toDouble(),
              'discountPriceKgs': itemData['discountPriceKgs']?.toDouble(),
              'discountStateKgs': itemData['discountStateKgs'] == true,
              'startPriceKzt': itemData['startPriceKzt']?.toDouble(),
              'discountPriceKzt': itemData['discountPriceKzt']?.toDouble(),
              'discountStateKzt': itemData['discountStateKzt'] == true,
              'startPriceMad': itemData['startPriceMad']?.toDouble(),
              'discountPriceMad': itemData['discountPriceMad']?.toDouble(),
              'discountStateMad': itemData['discountStateMad'] == true,
              'startPriceMdl': itemData['startPriceMdl']?.toDouble(),
              'discountPriceMdl': itemData['discountPriceMdl']?.toDouble(),
              'discountStateMdl': itemData['discountStateMdl'] == true,
              'startPriceMxn': itemData['startPriceMxn']?.toDouble(),
              'discountPriceMxn': itemData['discountPriceMxn']?.toDouble(),
              'discountStateMxn': itemData['discountStateMxn'] == true,
              'startPriceMyr': itemData['startPriceMyr']?.toDouble(),
              'discountPriceMyr': itemData['discountPriceMyr']?.toDouble(),
              'discountStateMyr': itemData['discountStateMyr'] == true,
              'startPriceNgn': itemData['startPriceNgn']?.toDouble(),
              'discountPriceNgn': itemData['discountPriceNgn']?.toDouble(),
              'discountStateNgn': itemData['discountStateNgn'] == true,
              'startPriceNpr': itemData['startPriceNpr']?.toDouble(),
              'discountPriceNpr': itemData['discountPriceNpr']?.toDouble(),
              'discountStateNpr': itemData['discountStateNpr'] == true,
              'startPriceNzd': itemData['startPriceNzd']?.toDouble(),
              'discountPriceNzd': itemData['discountPriceNzd']?.toDouble(),
              'discountStateNzd': itemData['discountStateNzd'] == true,
              'startPricePhp': itemData['startPricePhp']?.toDouble(),
              'discountPricePhp': itemData['discountPricePhp']?.toDouble(),
              'discountStatePhp': itemData['discountStatePhp'] == true,
              'startPricePkr': itemData['startPricePkr']?.toDouble(),
              'discountPricePkr': itemData['discountPricePkr']?.toDouble(),
              'discountStatePkr': itemData['discountStatePkr'] == true,
              'startPricePln': itemData['startPricePln']?.toDouble(),
              'discountPricePln': itemData['discountPricePln']?.toDouble(),
              'discountStatePln': itemData['discountStatePln'] == true,
              'startPriceQar': itemData['startPriceQar']?.toDouble(),
              'discountPriceQar': itemData['discountPriceQar']?.toDouble(),
              'discountStateQar': itemData['discountStateQar'] == true,
              'startPriceRon': itemData['startPriceRon']?.toDouble(),
              'discountPriceRon': itemData['discountPriceRon']?.toDouble(),
              'discountStateRon': itemData['discountStateRon'] == true,
              'startPriceRsd': itemData['startPriceRsd']?.toDouble(),
              'discountPriceRsd': itemData['discountPriceRsd']?.toDouble(),
              'discountStateRsd': itemData['discountStateRsd'] == true,
              'startPriceSar': itemData['startPriceSar']?.toDouble(),
              'discountPriceSar': itemData['discountPriceSar']?.toDouble(),
              'discountStateSar': itemData['discountStateSar'] == true,
              'startPriceSek': itemData['startPriceSek']?.toDouble(),
              'discountPriceSek': itemData['discountPriceSek']?.toDouble(),
              'discountStateSek': itemData['discountStateSek'] == true,
              'startPriceSgd': itemData['startPriceSgd']?.toDouble(),
              'discountPriceSgd': itemData['discountPriceSgd']?.toDouble(),
              'discountStateSgd': itemData['discountStateSgd'] == true,
              'startPriceThb': itemData['startPriceThb']?.toDouble(),
              'discountPriceThb': itemData['discountPriceThb']?.toDouble(),
              'discountStateThb': itemData['discountStateThb'] == true,
              'startPriceTjs': itemData['startPriceTjs']?.toDouble(),
              'discountPriceTjs': itemData['discountPriceTjs']?.toDouble(),
              'discountStateTjs': itemData['discountStateTjs'] == true,
              'startPriceZar': itemData['startPriceZar']?.toDouble(),
              'discountPriceZar': itemData['discountPriceZar']?.toDouble(),
              'discountStateZar': itemData['discountStateZar'] == true,
              'startPriceUyu': itemData['startPriceUyu']?.toDouble(),
              'discountPriceUyu': itemData['discountPriceUyu']?.toDouble(),
              'discountStateUyu': itemData['discountStateUyu'] == true,
              'startPriceChf': itemData['startPriceChf']?.toDouble(),
              'discountPriceChf': itemData['discountPriceChf']?.toDouble(),
              'discountStateChf': itemData['discountStateChf'] == true,
              'startPriceNok': itemData['startPriceNok']?.toDouble(),
              'discountPriceNok': itemData['discountPriceNok']?.toDouble(),
              'discountStateNok': itemData['discountStateNok'] == true,
              'startPriceGbp': itemData['startPriceGbp']?.toDouble(),
              'discountPriceGbp': itemData['discountPriceGbp']?.toDouble(),
              'discountStateGbp': itemData['discountStateGbp'] == true,
            });
          }).toList();
        }

        // Process other tables as before
        for (final table in ['genealogy', 'premium']) {
          if (data.containsKey(table)) {
            final tableData = data[table] as Map<String, dynamic>;
            tables[table] = tableData.entries.map((entry) {
              final itemData = entry.value as Map<String, dynamic>;
              print('Processing premium item: ${itemData['name']}');
              print('discountStateEu: ${itemData['discountStateEu']}');
              print('Raw item data: $itemData');
              return PriceItem.fromJson({
                'id': entry.key,
                'name': itemData['name'] as String? ?? 'Unknown',
                'category':
                    itemData['category'] as String? ?? table.capitalize(),
                'discountState': itemData['discountState'] == true,
                'discountStateEu': itemData['discountStateEu'] == true,
                'discountStateUsd': itemData['discountStateUsd'] == true,
                'discountStatePen': itemData['discountStatePen'] == true,
                'price': itemData['price']?.toDouble(),
                'priceEu': itemData['priceEu']?.toDouble(),
                'priceUsd': itemData['priceUsd']?.toDouble(),
                'pricePen': itemData['pricePen']?.toDouble(),
                'priceCl': itemData['priceCl']?.toDouble(),
                'priceAed': itemData['priceAed']?.toDouble(),
                'priceAll': itemData['priceAll']?.toDouble(),
                'priceAmd': itemData['priceAmd']?.toDouble(),
                'priceAoa': itemData['priceAoa']?.toDouble(),
                'priceAud': itemData['priceAud']?.toDouble(),
                'priceBam': itemData['priceBam']?.toDouble(),
                'priceBdt': itemData['priceBdt']?.toDouble(),
                'priceCzk': itemData['priceCzk']?.toDouble(),
                'priceDkk': itemData['priceDkk']?.toDouble(),
                'priceDzd': itemData['priceDzd']?.toDouble(),
                'priceEgp': itemData['priceEgp']?.toDouble(),
                'priceEtb': itemData['priceEtb']?.toDouble(),
                'priceGel': itemData['priceGel']?.toDouble(),
                'priceHkd': itemData['priceHkd']?.toDouble(),
                'priceHuf': itemData['priceHuf']?.toDouble(),
                'priceInr': itemData['priceInr']?.toDouble(),
                'priceKes': itemData['priceKes']?.toDouble(),
                'priceKgs': itemData['priceKgs']?.toDouble(),
                'priceKzt': itemData['priceKzt']?.toDouble(),
                'priceMad': itemData['priceMad']?.toDouble(),
                'priceMdl': itemData['priceMdl']?.toDouble(),
                'priceMxn': itemData['priceMxn']?.toDouble(),
                'priceMyr': itemData['priceMyr']?.toDouble(),
                'priceNgn': itemData['priceNgn']?.toDouble(),
                'priceNpr': itemData['priceNpr']?.toDouble(),
                'priceNzd': itemData['priceNzd']?.toDouble(),
                'pricePhp': itemData['pricePhp']?.toDouble(),
                'pricePkr': itemData['pricePkr']?.toDouble(),
                'pricePln': itemData['pricePln']?.toDouble(),
                'priceQar': itemData['priceQar']?.toDouble(),
                'priceRon': itemData['priceRon']?.toDouble(),
                'priceRsd': itemData['priceRsd']?.toDouble(),
                'priceSar': itemData['priceSar']?.toDouble(),
                'priceSek': itemData['priceSek']?.toDouble(),
                'priceSgd': itemData['priceSgd']?.toDouble(),
                'priceThb': itemData['priceThb']?.toDouble(),
                'priceTjs': itemData['priceTjs']?.toDouble(),
                'priceZar': itemData['priceZar']?.toDouble(),
                'priceUyu': itemData['priceUyu']?.toDouble(),
                'priceChf': itemData['priceChf']?.toDouble(),
                'priceNok': itemData['priceNok']?.toDouble(),
                'priceGbp': itemData['priceGbp']?.toDouble(),
                'startPriceEu': itemData['startPriceEu']?.toDouble(),
                'discountPriceEu': itemData['discountPriceEu']?.toDouble(),
                'startPriceUsd': itemData['startPriceUsd']?.toDouble(),
                'discountPriceUsd': itemData['discountPriceUsd']?.toDouble(),
                'startPricePen': itemData['startPricePen']?.toDouble(),
                'discountPricePen': itemData['discountPricePen']?.toDouble(),
                'startPriceCl': itemData['startPriceCl']?.toDouble(),
                'discountPriceCl': itemData['discountPriceCl']?.toDouble(),
                'discountStateCl': itemData['discountStateCl'] == true,
                'startPriceAed': itemData['startPriceAed']?.toDouble(),
                'discountPriceAed': itemData['discountPriceAed']?.toDouble(),
                'discountStateAed': itemData['discountStateAed'] == true,
                'startPriceAll': itemData['startPriceAll']?.toDouble(),
                'discountPriceAll': itemData['discountPriceAll']?.toDouble(),
                'discountStateAll': itemData['discountStateAll'] == true,
                'startPriceAmd': itemData['startPriceAmd']?.toDouble(),
                'discountPriceAmd': itemData['discountPriceAmd']?.toDouble(),
                'discountStateAmd': itemData['discountStateAmd'] == true,
                'startPriceAoa': itemData['startPriceAoa']?.toDouble(),
                'discountPriceAoa': itemData['discountPriceAoa']?.toDouble(),
                'discountStateAoa': itemData['discountStateAoa'] == true,
                'startPriceAud': itemData['startPriceAud']?.toDouble(),
                'discountPriceAud': itemData['discountPriceAud']?.toDouble(),
                'discountStateAud': itemData['discountStateAud'] == true,
                'startPriceBam': itemData['startPriceBam']?.toDouble(),
                'discountPriceBam': itemData['discountPriceBam']?.toDouble(),
                'discountStateBam': itemData['discountStateBam'] == true,
                'startPriceBdt': itemData['startPriceBdt']?.toDouble(),
                'discountPriceBdt': itemData['discountPriceBdt']?.toDouble(),
                'discountStateBdt': itemData['discountStateBdt'] == true,
                'startPriceCzk': itemData['startPriceCzk']?.toDouble(),
                'discountPriceCzk': itemData['discountPriceCzk']?.toDouble(),
                'discountStateCzk': itemData['discountStateCzk'] == true,
                'startPriceDkk': itemData['startPriceDkk']?.toDouble(),
                'discountPriceDkk': itemData['discountPriceDkk']?.toDouble(),
                'discountStateDkk': itemData['discountStateDkk'] == true,
                'startPriceDzd': itemData['startPriceDzd']?.toDouble(),
                'discountPriceDzd': itemData['discountPriceDzd']?.toDouble(),
                'discountStateDzd': itemData['discountStateDzd'] == true,
                'startPriceEgp': itemData['startPriceEgp']?.toDouble(),
                'discountPriceEgp': itemData['discountPriceEgp']?.toDouble(),
                'discountStateEgp': itemData['discountStateEgp'] == true,
                'startPriceEtb': itemData['startPriceEtb']?.toDouble(),
                'discountPriceEtb': itemData['discountPriceEtb']?.toDouble(),
                'discountStateEtb': itemData['discountStateEtb'] == true,
                'startPriceGel': itemData['startPriceGel']?.toDouble(),
                'discountPriceGel': itemData['discountPriceGel']?.toDouble(),
                'discountStateGel': itemData['discountStateGel'] == true,
                'startPriceHkd': itemData['startPriceHkd']?.toDouble(),
                'discountPriceHkd': itemData['discountPriceHkd']?.toDouble(),
                'discountStateHkd': itemData['discountStateHkd'] == true,
                'startPriceHuf': itemData['startPriceHuf']?.toDouble(),
                'discountPriceHuf': itemData['discountPriceHuf']?.toDouble(),
                'discountStateHuf': itemData['discountStateHuf'] == true,
                'startPriceInr': itemData['startPriceInr']?.toDouble(),
                'discountPriceInr': itemData['discountPriceInr']?.toDouble(),
                'discountStateInr': itemData['discountStateInr'] == true,
                'startPriceKes': itemData['startPriceKes']?.toDouble(),
                'discountPriceKes': itemData['discountPriceKes']?.toDouble(),
                'discountStateKes': itemData['discountStateKes'] == true,
                'startPriceKgs': itemData['startPriceKgs']?.toDouble(),
                'discountPriceKgs': itemData['discountPriceKgs']?.toDouble(),
                'discountStateKgs': itemData['discountStateKgs'] == true,
                'startPriceKzt': itemData['startPriceKzt']?.toDouble(),
                'discountPriceKzt': itemData['discountPriceKzt']?.toDouble(),
                'discountStateKzt': itemData['discountStateKzt'] == true,
                'startPriceMad': itemData['startPriceMad']?.toDouble(),
                'discountPriceMad': itemData['discountPriceMad']?.toDouble(),
                'discountStateMad': itemData['discountStateMad'] == true,
                'startPriceMdl': itemData['startPriceMdl']?.toDouble(),
                'discountPriceMdl': itemData['discountPriceMdl']?.toDouble(),
                'discountStateMdl': itemData['discountStateMdl'] == true,
                'startPriceMxn': itemData['startPriceMxn']?.toDouble(),
                'discountPriceMxn': itemData['discountPriceMxn']?.toDouble(),
                'discountStateMxn': itemData['discountStateMxn'] == true,
                'startPriceMyr': itemData['startPriceMyr']?.toDouble(),
                'discountPriceMyr': itemData['discountPriceMyr']?.toDouble(),
                'discountStateMyr': itemData['discountStateMyr'] == true,
                'startPriceNgn': itemData['startPriceNgn']?.toDouble(),
                'discountPriceNgn': itemData['discountPriceNgn']?.toDouble(),
                'discountStateNgn': itemData['discountStateNgn'] == true,
                'startPriceNpr': itemData['startPriceNpr']?.toDouble(),
                'discountPriceNpr': itemData['discountPriceNpr']?.toDouble(),
                'discountStateNpr': itemData['discountStateNpr'] == true,
                'startPriceNzd': itemData['startPriceNzd']?.toDouble(),
                'discountPriceNzd': itemData['discountPriceNzd']?.toDouble(),
                'discountStateNzd': itemData['discountStateNzd'] == true,
                'startPricePhp': itemData['startPricePhp']?.toDouble(),
                'discountPricePhp': itemData['discountPricePhp']?.toDouble(),
                'discountStatePhp': itemData['discountStatePhp'] == true,
                'startPricePkr': itemData['startPricePkr']?.toDouble(),
                'discountPricePkr': itemData['discountPricePkr']?.toDouble(),
                'discountStatePkr': itemData['discountStatePkr'] == true,
                'startPricePln': itemData['startPricePln']?.toDouble(),
                'discountPricePln': itemData['discountPricePln']?.toDouble(),
                'discountStatePln': itemData['discountStatePln'] == true,
                'startPriceQar': itemData['startPriceQar']?.toDouble(),
                'discountPriceQar': itemData['discountPriceQar']?.toDouble(),
                'discountStateQar': itemData['discountStateQar'] == true,
                'startPriceRon': itemData['startPriceRon']?.toDouble(),
                'discountPriceRon': itemData['discountPriceRon']?.toDouble(),
                'discountStateRon': itemData['discountStateRon'] == true,
                'startPriceRsd': itemData['startPriceRsd']?.toDouble(),
                'discountPriceRsd': itemData['discountPriceRsd']?.toDouble(),
                'discountStateRsd': itemData['discountStateRsd'] == true,
                'startPriceSar': itemData['startPriceSar']?.toDouble(),
                'discountPriceSar': itemData['discountPriceSar']?.toDouble(),
                'discountStateSar': itemData['discountStateSar'] == true,
                'startPriceSek': itemData['startPriceSek']?.toDouble(),
                'discountPriceSek': itemData['discountPriceSek']?.toDouble(),
                'discountStateSek': itemData['discountStateSek'] == true,
                'startPriceSgd': itemData['startPriceSgd']?.toDouble(),
                'discountPriceSgd': itemData['discountPriceSgd']?.toDouble(),
                'discountStateSgd': itemData['discountStateSgd'] == true,
                'startPriceThb': itemData['startPriceThb']?.toDouble(),
                'discountPriceThb': itemData['discountPriceThb']?.toDouble(),
                'discountStateThb': itemData['discountStateThb'] == true,
                'startPriceTjs': itemData['startPriceTjs']?.toDouble(),
                'discountPriceTjs': itemData['discountPriceTjs']?.toDouble(),
                'discountStateTjs': itemData['discountStateTjs'] == true,
                'startPriceZar': itemData['startPriceZar']?.toDouble(),
                'discountPriceZar': itemData['discountPriceZar']?.toDouble(),
                'discountStateZar': itemData['discountStateZar'] == true,
                'startPriceUyu': itemData['startPriceUyu']?.toDouble(),
                'discountPriceUyu': itemData['discountPriceUyu']?.toDouble(),
                'discountStateUyu': itemData['discountStateUyu'] == true,
                'startPriceChf': itemData['startPriceChf']?.toDouble(),
                'discountPriceChf': itemData['discountPriceChf']?.toDouble(),
                'discountStateChf': itemData['discountStateChf'] == true,
                'startPriceNok': itemData['startPriceNok']?.toDouble(),
                'discountPriceNok': itemData['discountPriceNok']?.toDouble(),
                'discountStateNok': itemData['discountStateNok'] == true,
                'startPriceGbp': itemData['startPriceGbp']?.toDouble(),
                'discountPriceGbp': itemData['discountPriceGbp']?.toDouble(),
                'discountStateGbp': itemData['discountStateGbp'] == true,
              });
            }).toList();
          }
        }

        return tables;
      } on DioException catch (e) {
        if (attempt == maxRetries) {
          throw PriceRepositoryException(
              'Failed after $maxRetries attempts: ${e.message}', e);
        }
        await Future.delayed(retryDelay);
      }
    }
    throw PriceRepositoryException('Unexpected error after retries');
  }

  @override
  Future<Map<String, List<PriceItem>>> build() {
    return fetchPrices();
  }
}

class PriceRepositoryException implements Exception {
  final String message;
  final dynamic error;

  PriceRepositoryException(this.message, [this.error]);

  @override
  String toString() =>
      'PriceRepositoryException: $message${error != null ? ' ($error)' : ''}';
}

// Add extension method for string capitalization
extension StringExtension on String {
  String capitalize() {
    return "${this[0].toUpperCase()}${substring(1)}";
  }
}
